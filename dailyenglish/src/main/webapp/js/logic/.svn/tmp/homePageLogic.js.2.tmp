function getCurrentTime(){
	var time;
	jUserLoginIn.getCurrentTime(function(data){
		if(data != null){
			time = data;
		}else{
			return null;
		}
	});
	return time;
}

function formatData(data,number){
	var checkbox = "<td id='check'><input id='checkbox"+number+"' type='checkbox' name='chkBoxImport'></td>";
	var title = "<td id='title"+number+"'><a href='javascript:showPost(\""+data.title+"\");'>" + data.title + "</a></td>";
	var author = "<td id='author"+number+"'>" + data.author + "</td>";
	var time = "<td id='date"+number+"'>" + formatPostDate(data.createDate) + "</td>";
	return checkbox + title + author + time;
}

function showPost(title){
	JqueryDialog.Open('帖子信息', 'postinformation.html', 300, 300, title,false);
}

function initialDialog(field){
	jPost.getPostByTitle(field,function(data){
		$("#posttitle").val(data.title);
		$("#postcontent").val(data.content);
		$("#createDate").val(formatPostDate(data.createDate));
		$("#changeDate").val(formatPostDate(data.lastChange));
		$("#postauthor").val(data.author);
		pageState.initialPost.title = data.title;
		pageState.initialPost.content = data.content;
	});
}

function createPost(){
	JqueryDialog.Open('创建新帖子', 'postinformation.html', 300, 300,"",true);
	$("#postauthor").hide();
	$("#create").hide();
	$("#change").hide();
	$("#author").hide();
}

function deletePost(){
	var tableObj = document.getElementsByName("chkBoxImport");
	var deleteTitles = new Array();
	var j = 0;
	for(var i in tableObj){
		var obj = tableObj[i];
		if(obj.type == "checkbox" && obj.checked){
			var id = obj.id.toString();
			var s = id.substring(id.length-1);
			var idStr = "#" + "title" + s + "";
			var m = $(idStr).text().trim();
			deleteTitles[j++] = m;
		}
	}
	if(j > 0){
		var del = true;
		DWREngine.setAsync(false); 
		for(var i=0;i<deleteTitles.length;i++){
			jPost.validateAuthority(deleteTitles[i],function(data){
				if(!data){
					del = false;
				}
			});
		}
		DWREngine.setAsync(true);
		if(del){
			jPost.deletePostsByTitles(deleteTitles,function(){
				renderTableAndPaginator();
		    });
		}else{
			alert("您没有权限，请联系管理员");
		}
	}else{
		alert("请选择帖子");
	}
}

function submitPostInformation(isCreate){
	if(isCreate){
		var postbean = new Object();
		postbean.title = $("#posttitle").attr("value");
		postbean.content = $("#postcontent").attr("value");
		jPost.createPost(postbean,function(data){
			if(data){
				alert("Create Post Success");
			}
		});
	}else{
		validateChangeAndUpdate();
	}
	JqueryDialog.Close();
	renderTableAndPaginator()
}

function validateChangeAndUpdate(){
	var currenttitle = $("#posttitle").attr("value");
	var currentcontent = $("#postcontent").attr("value");
	if(currenttitle != pageState.initialPost.title || currentcontent != pageState.initialPost.content){
		var r=confirm("你改变了信息，要保存吗?");
		if(r){
			jPost.validateAuthority(pageState.initialPost.title,function(data){
				if(data){
					jPost.updatePost(currenttitle ,currentcontent,function(updateflag){
						if(updateflag){
							alert("更新信息成功");
						}
					});
				}else{
					alert("您没有权限，请联系管理员");
				}
			});
		}
	}
}
        
function display(){  
	highlightLeftNav("homePage");
	var time = getCurrentTime();
	$("#time").html(time);
	var post = "Jason发了新帖子";
	$("#postaction").html(post);
	renderTableAndPaginator();
}

function renderTableAndPaginator(){
	renderPaginator();
	makeTable();
	$('table#demo').bestTable();
}


function renderPaginator(){
	var rowsPerPage = tableMeta.state.page.rowsPerPage;
	var currentPage = 1 + Math.ceil(globalRecordOffset / rowsPerPage);
    jPost.getPostCount(function(data){
    	pageState.initialPost.totalRecords = data;
    	tableMeta.state.page.totalRecords = data;
    });
	var paging = new Paginator(currentPage, pageState.initialPost.totalRecords, rowsPerPage, "paging", "gotoPage");
	paging.render();
}

function gotoPage(pageNum){
	globalRecordOffset = (pageNum - 1) * tableMeta.state.page.rowsPerPage;
	tableMeta.state.page.recordOffset = globalRecordOffset;
	renderTableAndPaginator();
}

function makeTable(){
	var tStr = "";
	tStr += "<tr><td id='hcheck' title='click to select'>选择内容</td>" +
			"<td id='htitle' title='click to sort'>帖子标题</td>" +
			"<td id='hauthor' title='click to sort'>作者</td>" +
			"<td id='htime' title='click to sort'>发布时间</td></tr>";
	DWREngine.setAsync(false);  
	jPost.getAllPost(tableMeta.state,function(data){
		if(data != null){
			for(var i=0;i<data.length;i++){
				tStr += "<tr>";
				tStr += formatData(data[i],i);
				tStr += "</tr>";
			}
		}
	});  
	DWREngine.setAsync(true);
	$("#demo").html(tStr);
}
